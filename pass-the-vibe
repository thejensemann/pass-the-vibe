#!/usr/bin/env bash
#
# pass-the-vibe - Auto-document your Claude Code sessions per git branch
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VIBE_DIR=".vibe"
CLAUDE_SETTINGS=".claude/settings.local.json"

usage() {
    cat <<EOF
pass-the-vibe - Auto-document Claude Code sessions per git branch

Usage:
    pass-the-vibe init [--auto-commit]   Initialize in current git repository
    pass-the-vibe config [--auto-commit] Update configuration
    pass-the-vibe status                 Check if pass-the-vibe is configured
    pass-the-vibe help                   Show this help message

Options:
    --auto-commit    Automatically commit changes when Claude finishes

After initialization, all Claude Code prompts and responses will be
automatically logged to .vibe/<date>_<branch>.md files.
EOF
}

check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "Error: Not a git repository. Please run this inside a git repo."
        exit 1
    fi
}

write_config() {
    local repo_root="$1"
    local auto_commit="${2:-false}"

    cat > "$repo_root/$VIBE_DIR/config" <<EOF
# pass-the-vibe configuration
AUTO_COMMIT=$auto_commit
EOF
}

init() {
    check_git_repo

    local repo_root auto_commit="false"
    repo_root="$(git rev-parse --show-toplevel)"

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --auto-commit)
                auto_commit="true"
                shift
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    echo "Initializing pass-the-vibe in: $repo_root"

    # Create .vibe directory
    mkdir -p "$repo_root/$VIBE_DIR"
    echo "Created $VIBE_DIR/ directory"

    # Write config
    write_config "$repo_root" "$auto_commit"
    if [[ "$auto_commit" == "true" ]]; then
        echo "Auto-commit enabled"
    fi

    # Create .claude directory if needed
    mkdir -p "$repo_root/.claude"

    # Copy hook scripts to .vibe
    cp "$SCRIPT_DIR/hooks/on-prompt.sh" "$repo_root/$VIBE_DIR/"
    cp "$SCRIPT_DIR/hooks/on-stop.sh" "$repo_root/$VIBE_DIR/"
    chmod +x "$repo_root/$VIBE_DIR/on-prompt.sh"
    chmod +x "$repo_root/$VIBE_DIR/on-stop.sh"
    echo "Installed hook scripts to $VIBE_DIR/"

    # Create or update Claude settings (use absolute paths for reliability)
    local hooks_config
    hooks_config=$(cat <<HOOKS_JSON
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "$repo_root/$VIBE_DIR/on-prompt.sh"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "$repo_root/$VIBE_DIR/on-stop.sh"
          }
        ]
      }
    ]
  }
}
HOOKS_JSON
)

    if [[ -f "$repo_root/$CLAUDE_SETTINGS" ]]; then
        # Merge with existing settings using jq if available
        if command -v jq &> /dev/null; then
            local existing
            existing=$(cat "$repo_root/$CLAUDE_SETTINGS")
            echo "$existing" | jq --argjson new "$hooks_config" '. * $new' > "$repo_root/$CLAUDE_SETTINGS"
            echo "Merged hooks into existing $CLAUDE_SETTINGS"
        else
            echo "Warning: jq not installed. Please manually merge hooks config."
            echo "Hooks config saved to $repo_root/$VIBE_DIR/hooks-config.json"
            echo "$hooks_config" > "$repo_root/$VIBE_DIR/hooks-config.json"
        fi
    else
        echo "$hooks_config" > "$repo_root/$CLAUDE_SETTINGS"
        echo "Created $CLAUDE_SETTINGS with hooks configuration"
    fi

    # Add .vibe to .gitignore patterns that shouldn't be tracked (temp files)
    if [[ -f "$repo_root/.gitignore" ]]; then
        if ! grep -q "^\.vibe/\.tmp" "$repo_root/.gitignore" 2>/dev/null; then
            echo ".vibe/.tmp*" >> "$repo_root/.gitignore"
        fi
    fi

    echo ""
    echo "pass-the-vibe initialized successfully!"
    echo ""
    echo "Your Claude Code sessions will now be logged to:"
    echo "  $VIBE_DIR/<date>_<branch>.md"
    echo ""
    echo "These files are meant to be committed with your code changes."
}

config() {
    check_git_repo

    local repo_root auto_commit=""
    repo_root="$(git rev-parse --show-toplevel)"

    if [[ ! -d "$repo_root/$VIBE_DIR" ]]; then
        echo "Error: pass-the-vibe not initialized. Run 'pass-the-vibe init' first."
        exit 1
    fi

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --auto-commit)
                auto_commit="true"
                shift
                ;;
            --no-auto-commit)
                auto_commit="false"
                shift
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    if [[ -n "$auto_commit" ]]; then
        write_config "$repo_root" "$auto_commit"
        echo "Configuration updated: AUTO_COMMIT=$auto_commit"
    else
        # Show current config
        if [[ -f "$repo_root/$VIBE_DIR/config" ]]; then
            echo "Current configuration:"
            cat "$repo_root/$VIBE_DIR/config"
        else
            echo "No configuration file found"
        fi
    fi
}

status() {
    check_git_repo

    local repo_root
    repo_root="$(git rev-parse --show-toplevel)"

    if [[ -d "$repo_root/$VIBE_DIR" ]] && [[ -f "$repo_root/$CLAUDE_SETTINGS" ]]; then
        echo "pass-the-vibe is configured in this repository"
        echo ""

        # Show config
        if [[ -f "$repo_root/$VIBE_DIR/config" ]]; then
            echo "Settings:"
            grep -v "^#" "$repo_root/$VIBE_DIR/config" | grep -v "^$" | sed 's/^/  /'
            echo ""
        fi

        echo "Vibe logs:"
        if ls "$repo_root/$VIBE_DIR"/*.md 1> /dev/null 2>&1; then
            ls -la "$repo_root/$VIBE_DIR"/*.md
        else
            echo "  No logs yet"
        fi
    else
        echo "pass-the-vibe is not configured in this repository"
        echo "Run 'pass-the-vibe init' to set it up"
    fi
}

cmd="${1:-help}"
shift || true

case "$cmd" in
    init)
        init "$@"
        ;;
    config)
        config "$@"
        ;;
    status)
        status
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $cmd"
        usage
        exit 1
        ;;
esac
