#!/usr/bin/env bash
#
# pass-the-vibe - Auto-document your Claude Code sessions per git branch
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VIBE_DIR=".vibe"
CLAUDE_SETTINGS=".claude/settings.local.json"

usage() {
    cat <<EOF
pass-the-vibe - Auto-document Claude Code sessions per git branch

Usage:
    pass-the-vibe init [--auto-commit]   Initialize in current git repository
    pass-the-vibe config [--auto-commit] Update configuration
    pass-the-vibe status                 Check if pass-the-vibe is configured
    pass-the-vibe help                   Show this help message

Options:
    --auto-commit    Automatically commit changes when Claude finishes

After initialization, all Claude Code prompts and responses will be
automatically logged to .vibe/<date>_<branch>.md files.
EOF
}

check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "Error: Not a git repository. Please run this inside a git repo."
        exit 1
    fi
}

# Internal hook commands (called by Claude Code hooks)
hook_on_prompt() {
    # Get repo root for absolute paths
    local REPO_ROOT
    REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
    local VIBE_DIR="$REPO_ROOT/.vibe"

    # Read JSON input from stdin
    local input
    input=$(cat)

    # Extract prompt from input
    local prompt
    prompt=$(echo "$input" | jq -r '.prompt // .user_prompt // empty' 2>/dev/null || echo "")

    if [[ -z "$prompt" ]]; then
        exit 0
    fi

    # Get current git branch (sanitize for filename)
    local branch branch_safe
    branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    branch_safe=$(echo "$branch" | tr '/' '-' | tr ' ' '-')

    # Check if a log file already exists for this branch
    local existing_file log_file date_prefix
    existing_file=$(find "$VIBE_DIR" -maxdepth 1 -name "*_${branch_safe}.md" 2>/dev/null | head -1)

    if [[ -n "$existing_file" ]]; then
        # Use existing file
        log_file="$existing_file"
        date_prefix=$(basename "$existing_file" | sed "s/_${branch_safe}.md$//")
    else
        # Get branch creation date (date of first commit on this branch vs main/master)
        local main_branch="main"
        if ! git rev-parse --verify "$main_branch" &>/dev/null; then
            main_branch="master"
        fi

        # Get the date of the first commit on this branch
        date_prefix=""
        local merge_base
        merge_base=$(git merge-base HEAD "$main_branch" 2>/dev/null || echo "")
        if [[ -n "$merge_base" ]]; then
            # Get date of first commit after merge base
            date_prefix=$(git log --format=%cs "${merge_base}..HEAD" 2>/dev/null | tail -1)
        fi

        # Fallback to current date if we couldn't determine branch creation date
        if [[ -z "$date_prefix" ]]; then
            date_prefix=$(date +%Y-%m-%d)
        fi

        # Build filename
        log_file="$VIBE_DIR/${date_prefix}_${branch_safe}.md"
    fi

    # Create vibe directory if it doesn't exist
    mkdir -p "$VIBE_DIR"

    # Initialize file with header if it doesn't exist
    if [[ ! -f "$log_file" ]]; then
        {
            echo "# Vibe Log: $branch"
            echo ""
            echo "Date: $date_prefix"
            echo ""
            echo "---"
            echo ""
        } > "$log_file"
    fi

    # Get timestamp
    local timestamp
    timestamp=$(date +%H:%M:%S)

    # Append user prompt
    {
        echo "## [$timestamp] User"
        echo ""
        echo "$prompt"
        echo ""
    } >> "$log_file"

    # Store temp file reference for the stop hook
    echo "$log_file" > "$VIBE_DIR/.tmp_current_log"

    exit 0
}

hook_on_stop() {
    # Get repo root for absolute paths
    local REPO_ROOT
    REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
    local VIBE_DIR="$REPO_ROOT/.vibe"

    # Read JSON input from stdin
    local input
    input=$(cat)

    # Get the transcript path from the input
    local transcript_path
    transcript_path=$(echo "$input" | jq -r '.transcript_path // empty' 2>/dev/null || echo "")

    # Get current log file from temp reference
    if [[ ! -f "$VIBE_DIR/.tmp_current_log" ]]; then
        exit 0
    fi

    local log_file
    log_file=$(cat "$VIBE_DIR/.tmp_current_log")

    if [[ -z "$log_file" ]] || [[ ! -f "$log_file" ]]; then
        exit 0
    fi

    # Get timestamp
    local timestamp
    timestamp=$(date +%H:%M:%S)

    # Extract Claude's last response from transcript if available
    local response=""
    if [[ -n "$transcript_path" ]] && [[ -f "$transcript_path" ]]; then
        # Get the last assistant message and extract text content blocks
        # The transcript format has: .message.content[] with {type, text} blocks
        response=$(tail -200 "$transcript_path" 2>/dev/null | \
            grep '"type":"assistant"' | \
            tail -1 | \
            jq -r '[.message.content[] | select(.type == "text") | .text] | join("\n\n")' 2>/dev/null || echo "")
    fi

    # If we couldn't extract response, note that
    if [[ -z "$response" ]]; then
        response="*(Response logged - see conversation for details)*"
    fi

    # Append Claude's response
    {
        echo "## [$timestamp] Claude"
        echo ""
        echo "$response"
        echo ""
        echo "---"
        echo ""
    } >> "$log_file"

    # Clean up temp file
    rm -f "$VIBE_DIR/.tmp_current_log"

    # Check if auto-commit is enabled
    local AUTO_COMMIT="false"
    if [[ -f "$VIBE_DIR/config" ]]; then
        AUTO_COMMIT=$(grep "^AUTO_COMMIT=" "$VIBE_DIR/config" 2>/dev/null | cut -d= -f2 || echo "false")
    fi

    if [[ "$AUTO_COMMIT" == "true" ]]; then
        cd "$REPO_ROOT"

        # Check if there are any changes to commit
        if ! git diff --quiet HEAD 2>/dev/null || [[ -n $(git ls-files --others --exclude-standard) ]]; then
            local branch commit_timestamp
            branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
            commit_timestamp=$(date +"%Y-%m-%d %H:%M")

            git add -A
            git commit -m "Claude Code changes on $branch

Auto-committed by pass-the-vibe at $commit_timestamp
See .vibe/ for session documentation" 2>/dev/null || true
        fi
    fi

    exit 0
}

write_config() {
    local repo_root="$1"
    local auto_commit="${2:-false}"

    cat > "$repo_root/$VIBE_DIR/config" <<EOF
# pass-the-vibe configuration
AUTO_COMMIT=$auto_commit
EOF
}

init() {
    check_git_repo

    local repo_root auto_commit="false"
    repo_root="$(git rev-parse --show-toplevel)"

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --auto-commit)
                auto_commit="true"
                shift
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    echo "Initializing pass-the-vibe in: $repo_root"

    # Create .vibe directory
    mkdir -p "$repo_root/$VIBE_DIR"
    echo "Created $VIBE_DIR/ directory"

    # Write config
    write_config "$repo_root" "$auto_commit"
    if [[ "$auto_commit" == "true" ]]; then
        echo "Auto-commit enabled"
    fi

    # Create .claude directory if needed
    mkdir -p "$repo_root/.claude"

    # Create Claude settings with portable command references
    # Uses 'pass-the-vibe' command which should be in PATH
    local hooks_config
    hooks_config=$(cat <<'HOOKS_JSON'
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "command -v pass-the-vibe >/dev/null && pass-the-vibe _hook on-prompt"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "command -v pass-the-vibe >/dev/null && pass-the-vibe _hook on-stop"
          }
        ]
      }
    ]
  }
}
HOOKS_JSON
)

    if [[ -f "$repo_root/$CLAUDE_SETTINGS" ]]; then
        # Merge with existing settings using jq if available
        if command -v jq &> /dev/null; then
            local existing
            existing=$(cat "$repo_root/$CLAUDE_SETTINGS")
            echo "$existing" | jq --argjson new "$hooks_config" '. * $new' > "$repo_root/$CLAUDE_SETTINGS"
            echo "Merged hooks into existing $CLAUDE_SETTINGS"
        else
            echo "Warning: jq not installed. Please manually merge hooks config."
            echo "Hooks config saved to $repo_root/$VIBE_DIR/hooks-config.json"
            echo "$hooks_config" > "$repo_root/$VIBE_DIR/hooks-config.json"
        fi
    else
        echo "$hooks_config" > "$repo_root/$CLAUDE_SETTINGS"
        echo "Created $CLAUDE_SETTINGS with hooks configuration"
    fi

    # Add .vibe to .gitignore patterns that shouldn't be tracked (temp files)
    if [[ -f "$repo_root/.gitignore" ]]; then
        if ! grep -q "^\.vibe/\.tmp" "$repo_root/.gitignore" 2>/dev/null; then
            echo ".vibe/.tmp*" >> "$repo_root/.gitignore"
        fi
    fi

    echo ""
    echo "pass-the-vibe initialized successfully!"
    echo ""
    echo "Your Claude Code sessions will now be logged to:"
    echo "  $VIBE_DIR/<date>_<branch>.md"
    echo ""
    echo "The .claude/settings.local.json can be committed - it uses portable paths."
    echo "Teammates need pass-the-vibe in their PATH to use the hooks."
}

config() {
    check_git_repo

    local repo_root auto_commit=""
    repo_root="$(git rev-parse --show-toplevel)"

    if [[ ! -d "$repo_root/$VIBE_DIR" ]]; then
        echo "Error: pass-the-vibe not initialized. Run 'pass-the-vibe init' first."
        exit 1
    fi

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --auto-commit)
                auto_commit="true"
                shift
                ;;
            --no-auto-commit)
                auto_commit="false"
                shift
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    if [[ -n "$auto_commit" ]]; then
        write_config "$repo_root" "$auto_commit"
        echo "Configuration updated: AUTO_COMMIT=$auto_commit"
    else
        # Show current config
        if [[ -f "$repo_root/$VIBE_DIR/config" ]]; then
            echo "Current configuration:"
            cat "$repo_root/$VIBE_DIR/config"
        else
            echo "No configuration file found"
        fi
    fi
}

status() {
    check_git_repo

    local repo_root
    repo_root="$(git rev-parse --show-toplevel)"

    if [[ -d "$repo_root/$VIBE_DIR" ]] && [[ -f "$repo_root/$CLAUDE_SETTINGS" ]]; then
        echo "pass-the-vibe is configured in this repository"
        echo ""

        # Show config
        if [[ -f "$repo_root/$VIBE_DIR/config" ]]; then
            echo "Settings:"
            grep -v "^#" "$repo_root/$VIBE_DIR/config" | grep -v "^$" | sed 's/^/  /'
            echo ""
        fi

        echo "Vibe logs:"
        if ls "$repo_root/$VIBE_DIR"/*.md 1> /dev/null 2>&1; then
            ls -la "$repo_root/$VIBE_DIR"/*.md
        else
            echo "  No logs yet"
        fi
    else
        echo "pass-the-vibe is not configured in this repository"
        echo "Run 'pass-the-vibe init' to set it up"
    fi
}

cmd="${1:-help}"
shift || true

case "$cmd" in
    init)
        init "$@"
        ;;
    config)
        config "$@"
        ;;
    status)
        status
        ;;
    _hook)
        # Internal hook commands - not shown in help
        case "${1:-}" in
            on-prompt)
                hook_on_prompt
                ;;
            on-stop)
                hook_on_stop
                ;;
            *)
                echo "Unknown hook: ${1:-}"
                exit 1
                ;;
        esac
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $cmd"
        usage
        exit 1
        ;;
esac
